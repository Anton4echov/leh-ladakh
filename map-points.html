<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ö–∞—Ä—Ç–∞ –õ–∞–¥–∞–∫—Ö–∞ ‚Äî –í–∞—à–∏ –º–µ—Å—Ç–∞</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body {
    margin: 0;
    font-family: 'Lora', serif;
    background: url('https://cdn.glitch.global/bea12857-f511-461d-adbc-da5b46687f87/IMG_20231118_212542_728.jpg?v=1750048499482') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }
  header {
    background: rgba(0,0,0,0.6);
    padding: 20px;
    text-align: center;
  }
  h1 { margin: 0; font-size: 1.2rem; }
  main {
    background: rgba(0,0,0,0.6);
    max-width: 900px;
    margin: 30px auto;
    padding: 20px;
    border-radius: 8px;
  }
  #map { height: 600px; width: 100%; border-radius: 8px; margin-top: 20px; position: relative; }
  .upload-section, .action-buttons, .stats, .info {
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
  }
  .upload-section input[type="file"] { width: 100%; padding: 8px; margin-top: 10px; border-radius: 5px; border: none; }
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }
  .action-buttons button {
    margin: 5px;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    flex: 1;
    min-width: 200px;
  }
  .save-btn { background: #27ae60; color: white; }
  .orange { background: #f39c12; color: white; }
  .clear-btn { background: #e74c3c; color: white; }
  .delete-all-btn { background: #8e44ad; color: white; }
  .places-list-item { 
    margin: 5px 0; 
    padding: 8px; 
    background: rgba(255,255,255,0.15); 
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .places-list-item:hover {
    background: rgba(255,255,255,0.25);
  }
  .map-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .map-controls button {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s;
  }
  .map-controls button:hover {
    background: rgba(255,255,255,0.3);
  }
  .place-type {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-left: 10px;
    color: white;
  }
  .type-custom {
    background: #27ae60;
  }
  .type-default {
    background: #3498db;
  }
</style>
</head>
<body>
<header>
  <h1>–ö–∞—Ä—Ç–∞ –õ–∞–¥–∞–∫—Ö–∞ ‚Äî –í–∞—à–∏ –º–µ—Å—Ç–∞</h1>
</header>
<main>
  <div class="upload-section">
    <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª —Å –º–µ—Å—Ç–∞–º–∏</h3>
    <input type="file" id="file-input" accept=".csv" />
    <p>–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫–∏: name, latitude, longitude, description</p>
  </div>

  <div class="stats" id="stats">
    –í—Å–µ–≥–æ –º–µ—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–µ: <span id="points-count">0</span>
  </div>

  <div class="action-buttons">
    <button class="save-btn" id="save-all-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞</button>
    <button class="orange" id="save-new-btn">üÜï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –º–µ—Å—Ç–∞</button>
    <button class="clear-btn" id="clear-custom-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Å—Ç–∞</button>
    <button class="delete-all-btn" id="delete-all-btn">üí• –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞</button>
  </div>

  <div id="map">
    <div class="map-controls">
      <button id="reset-view">üìç –í–µ—Ä–Ω—É—Ç—å –∫ –õ–∞–¥–∞–∫—Ö—É</button>
      <button class="save-btn" id="quick-save-btn">üíæ –í—Å–µ –º–µ—Å—Ç–∞</button>
      <button class="orange" id="quick-save-new-btn">üÜï –ù–æ–≤—ã–µ –º–µ—Å—Ç–∞</button>
      <button class="delete-all-btn" id="quick-delete-all-btn">üí• –í—Å–µ –º–µ—Å—Ç–∞</button>
    </div>
  </div>

  <div class="info">
    <h3>üìã –°–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç:</h3>
    <ul id="places-list" style="list-style: none; padding-left: 0; max-height: 300px; overflow-y: auto;"></ul>
  </div>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
<script>
  const map = L.map('map').setView([34.1526, 77.5771], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let allMarkers = [];
  let lastSaveTime = new Date();
  
  const samplePlaces = [
    { name: "–õ–µ—Ö", lat: 34.1526, lng: 77.5771, description: "–°—Ç–æ–ª–∏—Ü–∞ –õ–∞–¥–∞–∫—Ö–∞" },
    { name: "–ú–æ–Ω–∞—Å—Ç—ã—Ä—å –¢–∏–∫—Å–∏", lat: 34.0675, lng: 77.6653, description: "–ö—Ä—É–ø–Ω–µ–π—à–∏–π –º–æ–Ω–∞—Å—Ç—ã—Ä—å –≤ –õ–∞–¥–∞–∫—Ö–µ" },
    { name: "–û–∑–µ—Ä–æ –ü–∞–Ω–≥–æ–Ω–≥", lat: 33.7234, lng: 78.7711, description: "–í—ã—Å–æ–∫–æ–≥–æ—Ä–Ω–æ–µ —Å–æ–ª–µ–Ω–æ–µ –æ–∑–µ—Ä–æ" },
    { name: "–ü–µ—Ä–µ–≤–∞–ª –ö—Ö–∞—Ä–¥—É–Ω–≥-–õ–∞", lat: 34.2819, lng: 77.6183, description: "–û–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –≤—ã—Å–æ–∫–∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–≤–∞–ª–æ–≤ –≤ –º–∏—Ä–µ" },
    { name: "–î–≤–æ—Ä–µ—Ü –õ–µ—Ö", lat: 34.1667, lng: 77.5833, description: "–ë—ã–≤—à–∏–π –∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –¥–≤–æ—Ä–µ—Ü" },
    { name: "–ú–æ–Ω–∞—Å—Ç—ã—Ä—å –•–µ–º–∏—Å", lat: 33.9117, lng: 77.7142, description: "–ö—Ä—É–ø–Ω—ã–π –º–æ–Ω–∞—Å—Ç—ã—Ä—å —à–∫–æ–ª—ã –î—Ä–∏–∫—É–Ω–≥ –ö–∞–≥—å—é" },
    { name: "–î–æ–ª–∏–Ω–∞ –ù—É–±—Ä–∞", lat: 34.6167, lng: 77.4667, description: "–í—ã—Å–æ–∫–æ–≥–æ—Ä–Ω–∞—è –ø—É—Å—Ç—ã–Ω—è —Å –ø–µ—Å—á–∞–Ω—ã–º–∏ –¥—é–Ω–∞–º–∏" }
  ];

  function updateStats() {
    const placesCount = allMarkers.length;
    const customCount = allMarkers.filter(m => m.isCustom).length;
    document.getElementById('points-count').textContent = `${placesCount} (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö: ${customCount})`;
    
    const list = document.getElementById('places-list');
    list.innerHTML = '';
    
    allMarkers.forEach(marker => {
      const item = document.createElement('li');
      item.className = 'places-list-item';
      
      const typeBadge = marker.isCustom ? 
        '<span class="place-type type-custom">–ù–æ–≤–æ–µ</span>' : 
        '<span class="place-type type-default">–°—Ç–∞–Ω–¥–∞—Ä—Ç</span>';
      
      item.innerHTML = `<b>${marker.name}</b> ${typeBadge}<br>${marker.lat.toFixed(4)}, ${marker.lng.toFixed(4)}<br>${marker.description}`;
      item.onclick = () => {
        map.setView([marker.lat, marker.lng], 12);
        marker.marker.openPopup();
      };
      list.appendChild(item);
    });
  }

  function addMarker(place, isCustom=false){
    const customIcon = L.divIcon({ html: 'üìç', iconSize: [30, 30], className: 'custom-marker' });
    const defaultIcon = L.divIcon({ html: 'üî¥', iconSize: [25, 25], className: 'default-marker' });

    const marker = L.marker([place.lat, place.lng], {
      icon: isCustom ? customIcon : defaultIcon
    }).addTo(map).bindPopup(`<b>${place.name}</b><br>${place.description||''}`);
    
    allMarkers.push({ 
      marker, 
      name: place.name, 
      lat: place.lat, 
      lng: place.lng, 
      description: place.description||'', 
      isCustom, 
      created: new Date() 
    });
    
    updateStats();
  }

  // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—Å—Ç
  function deleteAllPoints() {
    if (allMarkers.length === 0) {
      alert('–ù–µ—Ç –º–µ—Å—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!');
      return;
    }

    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï ${allMarkers.length} –º–µ—Å—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —Å –∫–∞—Ä—Ç—ã
      allMarkers.forEach(markerData => {
        map.removeLayer(markerData.marker);
      });
      
      // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ –º–∞—Ä–∫–µ—Ä–æ–≤
      allMarkers = [];
      
      updateStats();
      alert('üí• –í—Å–µ –º–µ—Å—Ç–∞ —É–¥–∞–ª–µ–Ω—ã!');
    }
  }

  function saveAllPoints(){
    if(!allMarkers.length) { alert('–ù–µ—Ç –º–µ—Å—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!'); return; }
    
    let filename = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):", "ladakh_all_places");
    if (!filename) return;
    
    let csv = "name,latitude,longitude,description,type\n";
    allMarkers.forEach(m=>{
      const escapedName = `"${m.name.replace(/"/g, '""')}"`;
      const escapedDescription = `"${(m.description || '').replace(/"/g, '""')}"`;
      csv += `${escapedName},${m.lat},${m.lng},${escapedDescription},${m.isCustom?'custom':'default'}\n`;
    });
    
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); 
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = `${filename}.csv`; 
    a.click();
    
    lastSaveTime = new Date();
    alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${allMarkers.length} –º–µ—Å—Ç –≤ —Ñ–∞–π–ª ${filename}.csv`);
  }

  function saveNewPoints() {
    const newMarkers = allMarkers.filter(marker => marker.isCustom && marker.created > lastSaveTime);
    if (newMarkers.length === 0) { alert('–ù–µ—Ç –Ω–æ–≤—ã—Ö –º–µ—Å—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!'); return; }

    let filename = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –º–µ—Å—Ç (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è):", "ladakh_new_places");
    if (!filename) return;

    let csvContent = "name,latitude,longitude,description\n";
    newMarkers.forEach(marker => {
      const escapedName = `"${marker.name.replace(/"/g, '""')}"`;
      const escapedDescription = `"${(marker.description || '').replace(/"/g, '""')}"`;
      csvContent += `${escapedName},${marker.lat},${marker.lng},${escapedDescription}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.setAttribute('href', URL.createObjectURL(blob));
    link.setAttribute('download', filename + '.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    lastSaveTime = new Date();
    alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${newMarkers.length} –Ω–æ–≤—ã—Ö –º–µ—Å—Ç –≤ —Ñ–∞–π–ª ${filename}.csv`);
  }

  function clearCustomPoints() {
    const customMarkers = allMarkers.filter(marker => marker.isCustom);
    if (customMarkers.length === 0) { alert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Å—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!'); return; }

    if (confirm(`–£–¥–∞–ª–∏—Ç—å ${customMarkers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Å—Ç?`)) {
      customMarkers.forEach(markerData => map.removeLayer(markerData.marker));
      allMarkers = allMarkers.filter(marker => !marker.isCustom);
      updateStats();
      alert('üóëÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Å—Ç–∞ —É–¥–∞–ª–µ–Ω—ã!');
    }
  }

  document.getElementById('file-input').addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results){
        let bounds = [];
        let loadedCount = 0;
        
        results.data.forEach(place=>{
          const name = place.name || place.place || place.location;
          const lat = parseFloat(place.latitude || place.lat);
          const lon = parseFloat(place.longitude || place.lng || place.lon);
          const description = place.description || "";
          
          if(!isNaN(lat) && !isNaN(lon)) {
            addMarker({name, lat, lng: lon, description}, true);
            bounds.push([lat, lon]);
            loadedCount++;
          }
        });
        
        if (bounds.length > 0) map.fitBounds(bounds, { padding: [20, 20] });
        alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${loadedCount} –º–µ—Å—Ç`);
      },
      error: function(error) { alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error); }
    });
  });

  // Click map to add new place
  map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:");
    if (!name) return;

    const description = prompt("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):") || "";

    addMarker({ name, lat, lng: lon, description }, true);
  });

  // Map control buttons
  document.getElementById('reset-view').addEventListener('click', function() {
    map.setView([34.1526, 77.5771], 8);
  });
  document.getElementById('save-all-btn').addEventListener('click', saveAllPoints);
  document.getElementById('save-new-btn').addEventListener('click', saveNewPoints);
  document.getElementById('quick-save-btn').addEventListener('click', saveAllPoints);
  document.getElementById('quick-save-new-btn').addEventListener('click', saveNewPoints);
  document.getElementById('clear-custom-btn').addEventListener('click', clearCustomPoints);
  
  // New delete all buttons
  document.getElementById('delete-all-btn').addEventListener('click', deleteAllPoints);
  document.getElementById('quick-delete-all-btn').addEventListener('click', deleteAllPoints);

  // Prevent map click when clicking buttons
  document.querySelectorAll('.map-controls button').forEach(btn => {
    btn.addEventListener('click', function(event){
      event.stopPropagation();
    });
  });

  // Add predefined places
  samplePlaces.forEach(p => addMarker(p, false));
</script>
</body>
</html>
